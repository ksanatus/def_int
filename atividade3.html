<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@14.7.0/distribute/nouislider.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.0.0/math.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link href="https://cdn.jsdelivr.net/npm/nouislider@14.7.0/distribute/nouislider.min.css" rel="stylesheet">

<style>
    body {
        font-family: 'Roboto', sans-serif;
        background-color: #f4f7fc;
        display: flex;
        justify-content: flex-start;  
        padding: 40px;
        margin: 0;
        flex-wrap: nowrap;  
    }

    h2 {
        font-size: 2.5rem;
        color: #0056b3;
        margin-bottom: 30px;
        text-align: center;
    }

    #sidebar {
        width: 350px;
        padding: 25px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-right: 30px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
    }

    button {
        background-color: #007bff;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
    }

    button:hover {
        background-color: #0056b3;
    }

    #main-content {
        display: flex;
        flex-direction: row;
        flex-grow: 1;  
    }

    #graph {
        margin-top: 30px;
        margin-left: 0;
        margin-right: 0;
    }

    #integralValues {
        font-size: 14px;
        line-height: 1.5;
        margin-top: 25px;
        text-align: center;
        background-color: #ffffff;
        padding: 10px;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        max-width: 320px;
        height: auto;
        max-height: 200px;
        overflow: hidden;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .integral-info {
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: 500;
    }

    .blue {
        color: #1e90ff;
    }

    .message {
        font-size: 18px;
        font-weight: bold;
        margin-top: 20px;
    }
</style>

<!-- Conteúdo -->
<div id="sidebar">
    <div>
        <label for="functionInput">Digite a função f(x) (exemplo: x^2):</label>
        <input type="text" id="functionInput" value="x^2">
        <button onclick="updateFunction()">Atualizar Função</button>
    </div>
    <div id="sliders">
        <div class="slider-container">
            <label for="xSlider">Limite inferior x:</label>
            <span id="xValue">1</span><br>
            <div id="xSlider"></div>
        </div>
        <div class="slider-container">
            <label for="hSlider">Valor de h:</label>
            <span id="hValue">2</span><br>
            <div id="hSlider"></div>
        </div>
    </div>
    <div id="integralValues">
        <div id="integralExpression"></div>
    </div>
</div>

<div id="main-content">
    <div id="graph"></div>
</div>

<script>
    // Função para calcular a integral definida no intervalo [x, x+h]
    // Função para calcular a integral definida no intervalo [x, x+h]
    function integralNumerica(func, x, h, n = 10000) {
        // Se h for muito pequeno, aproximamos a integral por f(x)
        if (h < 0.0001) { 
            return func(x);  // Aproximação de f(x) para h muito pequeno
        }

        let step = h / n;
        let sum = 0;
        for (let i = 0; i < n; i++) {
            sum += func(x + i * step) * step;
        }
        return sum;
    }

    let x = 1, h = 2;
    let funcString = "x^2"; 
    let f = math.parse(funcString).compile(); 

    // Atualizar a função a partir do input do usuário
    function updateFunction() {
        funcString = document.getElementById('functionInput').value;
        try {
            f = math.parse(funcString).compile(); 
            updateGraphs();
        } catch (e) {
            alert('Função inválida');
        }
    }

    // Função para avaliar a função
    function evaluateFunction(x) {
        return f.evaluate({ x: x });
    }

    // Atualizar gráficos e cálculos
    function updateGraphs() {
        // Cálculo da integral no intervalo [x, x+h]
        let integralValue = integralNumerica(evaluateFunction, x, h);

        // Atualizar o gráfico com a função f(x)
        let xValues = [];
        let fValues = [];
        for (let i = 0; i <= 10; i += 0.1) {
            xValues.push(i);
            fValues.push(evaluateFunction(i));
        }

        let trace1 = {
            x: xValues,
            y: fValues,
            type: 'scatter',
            mode: 'lines',
            name: 'f(x)',
            line: { color: "#007bff" }
        };

        let layout1 = {
            xaxis: { title: 'x' },
            yaxis: { title: 'f(x)' },
            width: 1000,
            height: 600
        };

        // Desenhando a área entre f(x) e o eixo x no intervalo [x, x+h]
        let areaTrace = {};
        if (h > 0) {
            let numSteps = 1000;
            let stepSize = h / numSteps;
            let areaX = [];
            let areaY = [];
            for (let i = 0; i <= numSteps; i++) {
                let xi = x + i * stepSize;
                areaX.push(xi);
                areaY.push(Math.max(0, evaluateFunction(xi)));
            }

            areaTrace = {
                x: areaX,
                y: areaY,
                fill: 'tozeroy',
                type: 'scatter',
                fillcolor: 'rgba(0, 123, 255, 0.3)',
                line: { color: 'rgba(0, 123, 255, 0.3)' }
            };
        }

        // Desenhando a linha tracejada nos limites de integração
        let dashedLines = [];
        let xLine1 = { x: [x, x], y: [0, evaluateFunction(x)], line: { color: 'black', dash: 'dash' } };
        let xLine2 = { x: [x + h, x + h], y: [0, evaluateFunction(x + h)], line: { color: 'black', dash: 'dash' } };
        dashedLines.push(xLine1, xLine2);

        // Atualizando o gráfico com as linhas tracejadas
        Plotly.react('graph', [trace1, areaTrace, ...dashedLines], layout1);

        // Exibir a integral no painel lateral
        document.getElementById('integralExpression').innerHTML = `$$\\int_{${x.toFixed(2)}}^{${(x + h).toFixed(2)}} f(x) \\, dx = ${integralValue.toFixed(2)}$$`;

        // Forçar renderização do MathJax para as novas expressões
        MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.body]);  
    }

    window.onload = function() {
        // Slider para o limite inferior x
        let xSlider = document.getElementById('xSlider');
        let xValueDisplay = document.getElementById('xValue');
        noUiSlider.create(xSlider, {
            start: x,
            range: { 'min': 0, 'max': 10 },
            step: 0.1
        });
        xSlider.noUiSlider.on('update', function(values) {
            x = parseFloat(values[0]);
            xValueDisplay.innerHTML = x.toFixed(2);
            updateGraphs();
        });

        // Slider para o valor de h
        let hSlider = document.getElementById('hSlider');
        let hValueDisplay = document.getElementById('hValue');
        noUiSlider.create(hSlider, {
            start: h,
            range: { 'min': 0, 'max': 10 },
            step: 0.1
        });
        hSlider.noUiSlider.on('update', function(values) {
            h = parseFloat(values[0]);
            hValueDisplay.innerHTML = h.toFixed(2);
            updateGraphs();
        });

        updateGraphs(); // Inicializa com o gráfico e cálculos atualizados
    };
</script>
